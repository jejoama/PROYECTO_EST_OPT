---
title: "Proyecto Estad铆stica y Optimizaci贸n"
date: "2025-12-15"
output: 
  html_document: default
  pdf_document: default
header-includes:
  - \usepackage{titling}
  - \pretitle{\begin{center}\LARGE}
  - \posttitle{\end{center}}
  - \preauthor{\begin{center}\small}
  - \postauthor{\end{center}}
author: |
  Jeremy Joel Aguilar Marin, Irene Barba La Orden, Luc铆a Benages Guijarro, Fabi谩n Calvo Castillo, Cristhian Torrico Castellon
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Para poder hacer un pron贸stico de los rendimientos futuros de los 5 activos del CSV stock_returns_trains_2.csv hemos empleado modelos ARIMA univariados, ajustados mediante la funci贸n `auto.arima` (correspondiente a la librer铆a: `forecast`). Esto lo que nos quiere decir es que si el rendimiento de hoy depende un poco del rendimiento de ayer, el modelo ARIMA lo detecta, ya que nuestro modelo ARIMA lo que hace es detectar los patrones en el tiempo, todo y que estos patrones sean o no insignificantes. Adem谩s, hay que tener en cuenta que ARIMA NO sobreajusta, no se inventa patrones inexistentes. Lo explicado con anterioridad es adecuado para series financieras con autocorrelaci贸n d茅bil.

A partir de esto, pudimos obtener dos variables fundamentales:

- El rendimiento esperado del activo (\(\mu_t\)), es decir, lo que el modelo anticipa que podr铆a ocurrir
- La desviaci贸n est谩ndar (\(\sigma_t\)), que refleja el nivel de riesgo asociado a esa predicci贸n.

Para poder comprobar todo estuviera bien ajustado, hemos procedido a comprobar los residuos con dos pruebas estad铆sticas habituales en series temporales:  

- LjungBox (mediante Box.test) --> que detecta si queda autocorrelaci贸n no explicada  
- ARCH (mediante ArchTest de la libreria *FinTS*) --> revisa si existe heterocedasticidad

Con esto podemos verificar que nuestro trabajo es razonable, y gracias a esto podemos verificar los apartados 2,3 y 4.

En el apartado 2, usamos la funci贸n `getPred()`, la cual nos ajusta un modelo ARIMA con los datos del activo para posteriormente actualizar los datos con la informaci贸n m谩s reciente hasta el d铆a \(t-1\) (con el fin de tener los datos mas actuales posibles). A partir de este modelo (ya actualizado) se obtiene:

- una predicci贸n del rendimeinto del activo del siguiente d铆a ma帽ana (\(\hat{\mu}_t\))
- una estimaci贸n de la incertidumbre del modelo (\(\hat{\sigma}_t\)) --> para saber que tan segura es nuestra predicci贸n

A continuaci贸n, tenemos la funci贸n `getPred_ts()`. Esta lo que hace es repetir el proceso de predicci贸n d铆a a d铆a y activo por activo. Su procesos es sencillo:

1. Empieza en el primer d铆a del periodo test
2. Calcula la predicci贸n de los activos
3. Guarda los datos
4. Hace lo mismo con el siguiente d铆a, e incorpora toda la informaci贸n.

Despues "construye" dos matrices:

- `mu_hat` --> Predicci贸n del rendimiento del activo para el d铆a t
- `se_hat` --> Desviaci贸n est谩ndar estimada para el d铆a t

Finalmente, se calcula el RMSE para evaluar la calidad de las predicciones. En nuestro caso, el RMSE obtenido fue de 0.0175, lo que indica que, en promedio, el modelo comete un error del 1.75% en la predicci贸n de los rendimientos diarios. Este nivel de error es razonable para datos financieros, que suelen presentar alta volatilidad. 

A continuaci贸n se describen las funciones utilizadas para obtener los pesos 贸ptimos, $\alpha_t$, para cada activo en $t=T+1, ..., T+r$ y el rendimiento acumulado total. Tendremos en cuenta dos casos: (3.1) permitiendo posiciones cortas y (3.2) restringi茅ndolas ($\alpha_t \geq 0$). Para ello se debe optimizar la funci贸n utilidad media-varianza, $U_{MV}$, para obtener estos pesos y as铆 obtener el mejor rendimiento mitigando el riesgo. 

Si nos fijamos en la funci贸n utilidad media-varianza,
$$U_{MV}=\alpha_t^T\mu_t-\frac{\gamma}{2}\alpha_t^T\Sigma_t\alpha_t,$$
$\mu_t$ corresponden a los valores esperados de los rendimientos calculados en el apartado anterior; $\Sigma_t$ es una matriz calculada a partir de la funci贸n `getSigmaMV` (como se indica en el enunciado); $\gamma$ es el coeficiente de aversi贸n al riesgo (que controla el peso que se le da a la varianza).

Ahora bien, considerando el primer caso (permitiendo posiciones cortas), para obtener un peso en un periodo $t$ utilizamos la funci贸n `getAlphaMV`. Esta funci贸n ha sido determinada a partir del m茅todo de los multiplicadores de Lagrange bajo la restricci贸n $\sum_i \alpha_{ti}=1$. Y para calcular los pesos para cada activo, hemos utilizado la funci贸n `getAlpha_ts` (proporcionada) donde sus variables de entrada son `mus` ($\mu_t$), `sigs` ($se_{hat}$), $\gamma$ (que hemos fijado a 20, penalizando fuertemente el riesgo), `getSigmaFunc` que es `getSigmaMV`, `getAlphaFunc` es `getAlphaMV`, y `Xtrain` y `Xtest` los rendimientos para train y test. Tambi茅n, dentro de `getAlpha_ts` se llama a la funci贸n `getAlpha` que combina las funciones `getAlphaMV` y `getSigmaMV`. Por 煤ltimo, hemos utilizado la funci贸n `getChecks` para verificar que se cumple la restricci贸n mencionada anteriormente ($\sum_i \alpha_{ti}=1$).

Y para calcular el rendimiento total hemos utilizado la funci贸n `getRet` (proporcionada). En este caso hemos obtenido un rendimiento total de 2.95.

Por otro lado, para el caso de posiciones largas (3.2), hemos realizado exactamente el mismo procedimiento, excepto para el c谩lculo de $\alpha_t$ ya que tenemos que tener en cuenta que solo se consideran valores positivos (adem谩s de la restricci贸n de la suma de todos los pesos). Hemos utilizado la funci贸n `getAlphaMVPos` donde se ha hecho uso de `solve.QP` del paquete `quadprog`, que permite resolver problemas de optimizaci贸n cuadr谩tica sujeta a restricciones lineales.

En este caso hemos obtenido un rendimiento de 0.62. A diferencia del caso anterior donde hab铆amos obtenido un 2.95. Puede ser debido a que al restringir 煤nicamente a pesos positivos, limitamos m谩s las combinaciones posibles (elimina la posibilidad de de neutralizar riesgo con cortos) y, por tanto, reduce las posibilidades de obtener una mejor rentabilidad.



En un principio se ha hecho un an谩lisis exploratorio y diagn贸tico de series temporales:
Las cinco series de retornos muestran datos desde 2000 hasta ~2009.
Se graficaron las cinco series temporales para evaluar visualmente su comportamiento. Algunas series muestran fluctuaciones m谩s pronunciadas, lo que sugiere mayor volatilidad. No se observan patrones estacionales evidentes, lo que es coherente con series de retornos financieros.


![Datos de las activos](images/series_temporales.png)

Se realiz贸 una descomposici贸n aditiva de las series. En estos datos, por lo general, las cinco series muestran comportamiento t铆pico de retornos financieros: fluctuaciones alrededor de cero, sin tendencia clara y con variabilidad irregular. No se observa estacionalidad evidente. Algunas series (como X2 y X4) presentan mayor volatilidad, mientras que otras (como X3) son m谩s estables. El componente aleatorio captura la mayor parte de la variabilidad.

Una visualizaci贸n con la serie X1 ser铆a la siguiente:
![Descomposici贸n](images/descomposicion.png)

En todas las series temporales se observa que los residuos en el tiempo oscilan alrededor de cero sin patrones visibles, tampoco muestran tendencia ni cambios bruscos de varianza.

El ACF de residuos, la mayor铆a de los lags est谩n dentro de las bandas de confianza y no hay autocorrelaci贸n significativa. Y el PACF de residuos es igual que la ACF: sin picos relevantes. No hay estructura remanente por modelar.


Los gr谩ficos ACF y PACF de la series en general muestran un decaimiento lento  X1 muestran [describe el patr贸n: por ejemplo, decaimiento lento en ACF y corte abrupto en PACF], lo que sugiere un modelo AR(p) adecuado. Esta informaci贸n gu铆a la selecci贸n de par谩metros en el modelo ARIMA.
![Residuos del Modelo ARIMA](images/residuos_arima.png)

Los an谩lisis de las series temporales indican que los retornos no exhiben tendencias o estacionalidades notables. Las descomposiciones corroboran que la mayor parte de la variabilidad se origina en el componente aleatorio. Las funciones ACF y PACF se帽alan que las series son adecuadas para el modelado ARIMA y presentan estacionaridad. Por 煤ltimo, los gr谩ficos de residuos evidencian la falta de autocorrelaci贸n y un comportamiento de ruido blanco, lo que confirma que los modelos ARIMA ajustados son adecuados para prever la volatilidad y los retornos.



Los resultados de las predicciones en estos casos nunca son exactos porque en mercados financieros los retornos son muy ruidosos, y el valor esperado suele ser m谩s suave.
En este caso, en la imagen se observa c贸mo en los 5 activos la l铆nea azul (predicha) es m谩s estable, pues ARIMA filtra el ruido de alta frecuencia.
Concretamente, en los activos 1, 4 y 5 se observan cambios de nivel, ARIMA se est谩 adaptando lentamente (esto puede ser devido a alguna dependencia temporal d茅bil).
Y los activos 2 y 3 son los m谩s cercanos a ruido blanco. Su retorno retorno real oscila al rededor de 0, y su predicci贸n es m谩s aplanada.

![Real vs Predicho](images/real_vs_predicho.png)

La volatilidad de estos activos se estim贸 como la desviaci贸n est谩ndar del pron贸stico one-step-ahead.
Dado que ARIMA asume varianza constante en los errores, la volatilidad estimada resulta pr谩cticamente constante en el periodo test para la mayor铆a de los activos, lo cual es consistente con las hip贸tesis del modelo.

En la gr谩fica se observa que el activo 1 se observa una leve pendiente o cambio suave. Esto ocurre porque el modelo ARIMA se reestima din谩micamente al incorporar nuevos datos, la estimaci贸n de 
^2 puede ajustarse ligeramente, especialmente si el modelo incluye integraci贸n (d > 0) o cambios en residuos. Con esto se cumple que la diagonal de 危ser谩 constante en , lo cual simplifica la optimizaci贸n.

En los dem谩s activos, el modelo ARIMA cl谩sico modela la media condicional del proceso, no modela volatilidad din谩mica, asume que los errores tienen varianza constante. Es por ello que los intervalos de predicci贸n tienen ancho casi constante, y por lo tanto, la volatilidad pronosticada es pr谩cticamente plana

![Volatilidad](images/volatilidad.png)

En la siguiente gr谩fica se observa la representaci贸n de c贸mo se asiganan los pesos promedio de inversi贸n en cada activo en el perioro de testeo bajo el modelo de utilidad media-varianza con posiciones cortas permitidas.

El activo 5 tiene el peso promedio m谩s alto (~0.8), es decir, posee un rendimiento esperado alto y una volatilidad controlad, el modelo conf铆a bastante en este activo. Los activos 1 y 4 presentan pesos positivos moderados (~0.4), son buenos, pero no hay tanta convicci贸n. Los activos 2 y 3 muestran caracter铆sticas menos atractivas (ya sea por bajo rendimiento esperado o alta volatilidad relativa), lo que lleva al modelo a asignarles posiciones cortas.

![Pesos Promedios](images/pesos_promedios.png)

La gr谩fica siguiente ilustra c贸mo ha cambiado el portafolio creado bajo la norma de utilidad logar铆tmica, cuyo objetivo es optimizar el crecimiento compuesto del capital. Este m茅todo, a diferencia de la utilidad media-varianza, castiga con severidad las p茅rdidas y promueve t谩cticas m谩s conservadoras en situaciones de volatilidad alta. Para calcular el valor acumulado, se utilizan los rendimientos ponderados por los pesos 贸ptimos en cada momento y, posteriormente, se suman los factores de crecimiento. La curva final muestra una tendencia ascendente, aceler谩ndose al final del periodo, lo cual sugiere que el modelo fue capaz de identificar oportunidades de inversi贸n con buena rentabilidad y modificar din谩micamente la distribuci贸n de activos en funci贸n del riesgo y el rendimiento esperado.

![Uitilidad Log](images/evolucion_utilidad_log.png)


# Distribuci贸n del proyecto

- Apartado 2: Jeremy Joel Aguilar Marin
- Apartado 3: Irene Barba La Orden y Fabi谩n Castillo Calvo
- Apartado 4: Luc铆a Benages Guijarro
Falta poner a Cristhian



